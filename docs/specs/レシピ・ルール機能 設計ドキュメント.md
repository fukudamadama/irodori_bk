# レシピ・ルール機能 設計ドキュメント

## 1. 要件

本システムは、ユーザーが自分のお金の流れを自動化するための「ルール」と、その集合である「レシピ」を自由に作成・利用できる機能を提供する。IFTTT(If This Then That)のように、「もし〇〇したら(トリガー)、△△ する(アクション)」という形式でルールを定義する。

### 主な要件

- **ルールの作成**: ユーザーは、システムが提供する「トリガー」と「アクション」の定義を組み合わせて、自分だけの「ルール」を作成できる。
- **ルールの分類**: 各ルールは、その目的別に「貯金」「投資」「節約」のいずれかのカテゴリに分類される。
- **レシピの作成**: ユーザーは、自作または他者から提供された複数の「ルール」を組み合わせて、特定の目的（例：節約、資産形成）を達成するための「レシピ」を作成できる。
- **マーケットプレイス**:
  - ユーザーは、作成したルールやレシピを「テンプレート」として公開し、他のユーザーと共有できる。
  - 他のユーザーは、公開されているテンプレートを検索・発見できる。
  - ユーザーは、気に入ったテンプレートを自分の設定にコピー（インスタンス化）して利用できる。
  - コピーしたルールやレシピは、自分用に自由にカスタマイズできる。
  - 人気のテンプレートが分かるように、「いいね」や「コピー数」などの指標を設ける。
- **柔軟性と拡張性**: 将来的に新しいトリガーやアクションの定義を追加する際に、既存のシステムや DB 構造への影響が最小限になるように設計する。

---

## 2. 利用イメージ

### シナリオ 1：ユーザー A が「ぜいたく税ルール」を作成し、公開する

1.  ユーザー A はアプリの UI 上で「ルール作成」を選択する。
2.  トリガー選択画面で「特定カテゴリでの支出」を選ぶ。
3.  アクション選択画面で「割合で貯金」を選ぶ。
4.  具体的なパラメータとして、トリガーのカテゴリに「カフェ」「コンビニ」、アクションの割合に「10%」を設定する。
5.  ルールに「ぜいたく税ルール」と名前を付け、「公開する」オプションをオンにして保存する。
6.  これにより、`rule_templates`テーブルに新しいレコードが 1 件作成される。

### シナリオ 2：ユーザー B が「ぜいたく税ルール」を見つけて利用する

1.  ユーザー B はマーケットプレイスで人気のルールを探し、ユーザー A が作成した「ぜいたく税ルール」を見つける。
2.  「このルールを使ってみる」ボタンを押す。
3.  システムは、`rule_templates`に保存されている A さんのルール定義を元に、ユーザー B の`user_active_rules`テーブルに新しいレコードをコピー（インスタンス化）する。この時、元のテンプレート ID も記録される。
4.  ユーザー B は、自分の設定画面でこのルールのパラメータ（割合など）を確認・調整し、「有効化」する。
5.  これにより、ユーザー B の支出に対して「ぜいたく税ルール」が適用され始める。同時に、元の`rule_templates`の`copies_count`が 1 増加する。

### シナリオ 3：ユーザー B が既存レシピをカスタマイズして新しいレシピとして公開する

1.  ユーザー B は、マーケットプレイスで見つけた「お散歩貯金レシピ」を自分の設定にコピーする。
2.  コピーしたレシピ内の「ノーマネーデー達成ボーナス」ルールの設定を、ご褒美 300 円から 500 円に変更する。
3.  さらに、自分が作成した「ぜいたく税ルール」をこのレシピに追加する。
4.  カスタマイズしたレシピに「改・お散歩貯金レシピ」と新しい名前を付け、「公開する」オプションをオンにして保存する。
5.  これにより、ユーザー B を作者とする新しいレシピが`recipe_templates`に作成され、マーケットプレイスに公開される。

---

## 3. テーブル設計

### `triggers`

利用可能なトリガーの「定義」を管理。
| カラム名 | データ型 | 説明 |
| :--- | :--- | :--- |
| `id` | `Integer` (PK) | トリガー定義 ID |
| `name` | `String(100)` | 名前 (例: `特定明細の入金`) |
| `description`| `String(500)` | UI に表示する説明文 |
| `required_params`| `JSON` | 設定に必要なパラメータの定義 |

### `actions`

利用可能なアクションの「定義」を管理。
| カラム名 | データ型 | 説明 |
| :--- | :--- | :--- |
| `id` | `Integer` (PK) | アクション定義 ID |
| `name` | `String(100)` | 名前 (例: `指定口座へ割合で振替`) |
| `description`| `String(500)` | UI に表示する説明文 |
| `required_params`| `JSON` | 設定に必要なパラメータの定義 |

### `rule_templates`

ユーザーが作成・公開できるルールの「テンプレート」。
| カラム名 | データ型 | 説明 |
| :--- | :--- | :--- |
| `id` | `Integer` (PK) | ルールテンプレート ID |
| `name` | `String(100)` | ルールの名前 |
| `description`| `String(500)` | ルールの説明 |
| `category` | `ENUM('貯金', '投資', '節約')` | ルールのカテゴリ |
| `author_id` | `Integer` (FK) | 作成者 (ユーザー ID) |
| `trigger_id` | `Integer` (FK) | `triggers.id`への FK |
| `trigger_params`| `JSON` | トリガーのパラメータのひな形 |
| `action_id` | `Integer` (FK) | `actions.id`への FK |
| `action_params` | `JSON` | アクションのパラメータのひな形 |
| `is_public` | `Boolean` | 公開設定 |
| `likes_count`| `Integer` | いいね数 |
| `copies_count`| `Integer` | コピーされた数 |
| `created_at`| `DateTime` | 作成日時 |
| `updated_at`| `DateTime` | 更新日時 |

### `recipe_templates`

ユーザーが作成・公開できるレシピの「テンプレート」。
| カラム名 | データ型 | 説明 |
| :--- | :--- | :--- |
| `id` | `Integer` (PK) | レシピテンプレート ID |
| `name` | `String(100)` | レシピの名前 |
| `description`| `String(500)` | レシピの説明 |
| `author_id` | `Integer` (FK) | 作成者 (ユーザー ID) |
| `is_public` | `Boolean` | 公開設定 |
| `likes_count`| `Integer` | いいね数 |
| `copies_count`| `Integer` | コピーされた数 |
| `created_at`| `DateTime` | 作成日時 |
| `updated_at`| `DateTime` | 更新日時 |

### `recipe_templates_rule_templates`

レシピテンプレートとルールテンプレートを関連付ける中間テーブル。
| カラム名 | データ型 | 説明 |
| :--- | :--- | :--- |
| `recipe_template_id` | `Integer` (FK) | `recipe_templates.id`への FK |
| `rule_template_id` | `Integer` (FK) | `rule_templates.id`への FK |

### `rules`

ユーザーが実際に有効化しているルールの「インスタンス」。
| カラム名 | データ型 | 説明 |
| :--- | :--- | :--- |
| `id` | `Integer` (PK) | ユーザールール ID |
| `user_id` | `Integer` (FK) | 所有者 (ユーザー ID) |
| `name` | `String(100)` | ユーザーが付けるルールの名前 |
| `description`| `String(500)` | ルールの説明 |
| `category` | `ENUM('貯金', '投資', '節約')` | ルールのカテゴリ |
| `template_id` | `Integer` (FK, NULL 許可) | `rule_templates.id`への FK |
| `trigger_id` | `Integer` (FK) | `triggers.id`への FK |
| `trigger_params` | `JSON` | ユーザーが設定した**具体的な値** |
| `action_id` | `Integer` (FK) | `actions.id`への FK |
| `action_params` | `JSON` | ユーザーが設定した**具体的な値** |
| `created_at`| `DateTime` | 作成日時 |
| `updated_at`| `DateTime` | 更新日時 |

### `recipes`

ユーザーが実際に有効化しているレシピの「インスタンス」。
| カラム名 | データ型 | 説明 |
| :--- | :--- | :--- |
| `id` | `Integer` (PK) | レシピ ID |
| `name` | `String(100)` | レシピの名前 |
| `description`| `String(500)` | レシピの説明 |
| `template_id` | `Integer` (FK, NULL 許可) | `recipe_templates.id`への FK |
| `user_id` | `Integer` (FK) | 所有者 (ユーザー ID) |
| `created_at`| `DateTime` | 作成日時 |
| `updated_at`| `DateTime` | 更新日時 |

### `recipes_rules`

レシピとルールを関連付ける中間テーブル。
| カラム名 | データ型 | 説明 |
| :--- | :--- | :--- |
| `recipe_id` | `Integer` (FK) | `recipes.id`への FK |
| `rule_id` | `Integer` (FK) | `rules.id`への FK |

---

## 4. サンプルデータ

(既存ユーザー ID は `1` とする)

### `triggers`

[
{
"id": 1,
"name": "カード決済",
"description": "カードでの支払いを検知します",
"required_params": {}
},
{
"id": 2,
"name": "特定カテゴリでの支出",
"description": "指定したカテゴリでの支出を検知します",
"required_params": {
"categories": ["string"]
}
},
{
"id": 3,
"name": "支出ゼロの日",
"description": "1 日の支出が 0 円だった場合に検知します",
"required_params": {}
},
{
"id": 4,
"name": "特定明細の入金",
"description": "特定のキーワードを含む入金を検知します",
"required_params": {
"keyword": "string"
}
},
{
"id": 5,
"name": "賞与明細の入金",
"description": "特定のキーワードを含む一定額以上の入金を検知します",
"required_params": {
"keyword": "string",
"min_amount": "number"
}
},
{
"id": 6,
"name": "月末",
"description": "毎月、月の最終日になったことを検知します",
"required_params": {}
}
]

### `actions`

[
{
"id": 101,
"name": "端数貯金",
"description": "設定金額を基準におつりを計算して貯金します",
"required_params": {
"base_amount": "number",
"destination_account": "string"
}
},
{
"id": 102,
"name": "割合で振替/貯金",
"description": "金額の指定割合を別口座に移します",
"required_params": {
"percentage": "number",
"destination_account": "string"
}
},
{
"id": 103,
"name": "固定額を振替/貯金",
"description": "指定した固定額を、別の口座へ移します",
"required_params": {
"amount": "number",
"destination_account": "string"
}
},
{
"id": 104,
"name": "固定額差引で振替",
"description": "金額から指定額を引いた残りを、別の口座へ移します",
"required_params": {
"leave_amount": "number",
"destination_account": "string"
}
},
{
"id": 105,
"name": "予算超過額を振替",
"description": "カテゴリの予算超過額を、別の口座へ移します",
"required_params": {
"categories": ["string"],
"destination_account": "string"
}
}
]

### `recipe_templates`

[
{
"id": 201,
"name": "【ちりつも浪費を宝物に変える】お散歩貯金レシピ",
"description": "コンビニやカフェでの何気ない出費を「見える化」し、楽しみながら自然と貯まる仕組みを作るレシピです。",
"author_id": 1,
"is_public": true,
"likes_count": 0,
"copies_count": 0,
"created_at": "2025-08-02T23:07:00Z",
"updated_at": "2025-08-02T23:07:00Z"
},
{
"id": 202,
"name": "【給料即ロック】ストイック資産形成レシピ",
"description": "給料が入った瞬間に先取りで貯蓄・投資へ回し、残ったお金で生活する習慣を徹底するレシピです。",
"author_id": 1,
"is_public": true,
"likes_count": 0,
"copies_count": 0,
"created_at": "2025-08-02T23:07:00Z",
"updated_at": "2025-08-02T23:07:00Z"
}
]

### `rule_templates`

[
{
"id": 1001,
"name": "カード決済でおつり貯金",
"description": "カードで支払うたびに、500 円玉で払ったおつりを貯金します。",
"author_id": 1,
"trigger_id": 1,
"trigger_params": {},
"action_id": 101,
"action_params": {
"base_amount": 500,
"destination_account": "savings"
},
"is_public": true,
"likes_count": 0,
"copies_count": 0,
"created_at": "2025-08-02T23:07:00Z",
"updated_at": "2025-08-02T23:07:00Z"
},
{
"id": 1002,
"name": "ぜいたく税貯金",
"description": "カフェやコンビニで使った金額の 10%を、自分への税金として貯金します。",
"author_id": 1,
"trigger_id": 2,
"trigger_params": {
"categories": ["カフェ", "コンビニ"]
},
"action_id": 102,
"action_params": {
"percentage": 10,
"destination_account": "savings"
},
"is_public": true,
"likes_count": 0,
"copies_count": 0,
"created_at": "2025-08-02T23:07:00Z",
"updated_at": "2025-08-02T23:07:00Z"
},
{
"id": 1003,
"name": "ノーマネーデー達成ボーナス",
"description": "お金を使わなかった日に、自分へのご褒美として 300 円を貯金します。",
"author_id": 1,
"trigger_id": 3,
"trigger_params": {},
"action_id": 103,
"action_params": {
"amount": 300,
"destination_account": "savings"
},
"is_public": true,
"likes_count": 0,
"copies_count": 0,
"created_at": "2025-08-02T23:07:00Z",
"updated_at": "2025-08-02T23:07:00Z"
},
{
"id": 1004,
"name": "給与天引き強制投資",
"description": "給料が入ったら、すぐに 25%を投資に回して先取り投資をします。",
"author_id": 1,
"trigger_id": 4,
"trigger_params": { "keyword": "給与" },
"action_id": 102,
"action_params": { "percentage": 25, "destination_account": "investment" },
"is_public": true,
"likes_count": 0,
"copies_count": 0,
"created_at": "2025-08-02T23:07:00Z",
"updated_at": "2025-08-02T23:07:00Z"
},
{
"id": 1005,
"name": "ボーナス全力投資",
"description": "ボーナスから生活防衛用の 5 万円だけ残し、あとは全部投資に回します。",
"author_id": 1,
"trigger_id": 5,
"trigger_params": { "keyword": "賞与", "min_amount": 100000 },
"action_id": 104,
"action_params": { "leave_amount": 50000, "destination_account": "investment" },
"is_public": true,
"likes_count": 0,
"copies_count": 0,
"created_at": "2025-08-02T23:07:00Z",
"updated_at": "2025-08-02T23:07:00Z"
},
{
"id": 1006,
"name": "予算超過ペナルティ貯金",
"description": "食費や交際費が予算を超えたら、罰として超過額を強制的に貯金します。",
"author_id": 1,
"trigger_id": 6,
"trigger_params": {},
"action_id": 105,
"action_params": { "categories": ["食費", "交際費"], "destination_account": "savings" },
"is_public": true,
"likes_count": 0,
"copies_count": 0,
"created_at": "2025-08-02T23:07:00Z",
"updated_at": "2025-08-02T23:07:00Z"
}
]

### `recipe_templates_rule_templates`

[
{ "recipe_template_id": 201, "rule_template_id": 1001 },
{ "recipe_template_id": 201, "rule_template_id": 1002 },
{ "recipe_template_id": 201, "rule_template_id": 1003 },
{ "recipe_template_id": 202, "rule_template_id": 1004 },
{ "recipe_template_id": 202, "rule_template_id": 1005 },
{ "recipe_template_id": 202, "rule_template_id": 1006 }
]
